#!/usr/bin/python

import sys
import argparse

sys.path.append('..')
from elem.elem import Elem

sys.dont_write_bytecode = True

def str2bool(v):
    if v.lower() in ('yes', 'true', 't', 'y', '1'):
        return True
    elif v.lower() in ('no', 'false', 'f', 'n', '0'):
        return False
    else:
        raise argparse.ArgumentTypeError('Boolean value expected.')

def main():

    parser = argparse.ArgumentParser(description='Cross Reference CVE\'s against a Exploit-DB entries for Enterprise Linux.')

    subparsers = parser.add_subparsers()
    refresh_parser = subparsers.add_parser('refresh')
    refresh_parser.add_argument('--refresh',
                          required=False,
                          type=str2bool,
                          nargs='?',
                          const=True,
                          default='t',
                          help=argparse.SUPPRESS)
    refresh_parser.add_argument('--exploitdb',
                          help='Exploit DB directory to search',
                          required=False)
    refresh_parser.add_argument('--securityapi',
                          help='Red Hat Security API base URL.',
                          required=False,
                          default='https://access.redhat.com/labs/securitydataapi')
    refresh_parser.add_argument('--api',
                          required=False,
                          type=str2bool,
                          nargs='?',
                          const=True,
                          default='f',
                          help="Query the Red Hat Security API for new CVE's")


    list_parser = subparsers.add_parser('list')
    list_parser.add_argument('--list',
                          required=False,
                          type=str2bool,
                          nargs='?',
                          const=True,
                          default='t',
                          help=argparse.SUPPRESS)
    list_parser.add_argument('--edbid',
                          help="The edbid on which to filter.",
                          required=False,
                          type=int)

    score_parser = subparsers.add_parser('score')
    score_parser.add_argument('--score',
                          required=False,
                          type=str2bool,
                          nargs='?',
                          const=True,
                          default='t',
                          help=argparse.SUPPRESS)
    score_parser.add_argument('--edbid',
                          help='Which exploit to score',
                          required=True,
                          type=int)
    score_parser.add_argument('--version',
                          required=True,
                          type=str)
    score_parser.add_argument('--spoof',
                          required=False,
                          help='Spoofing Score',
                          type=int,
                          default=None)
    score_parser.add_argument('--tampering',
                          required=False,
                          help='Tampering Score',
                          type=int,
                          default=None)
    score_parser.add_argument('--repudiation',
                          required=False,
                          help='Repudiation Score',
                          type=int,
                          default=None)
    score_parser.add_argument('--infodisclosure',
                          required=False,
                          help='Information Disclosure Score',
                          type=int,
                          default=None)
    score_parser.add_argument('--dos',
                          required=False,
                          help='Denial of Service Score',
                          type=int,
                          default=None)
    score_parser.add_argument('--escallation',
                          required=False,
                          help='Escallation of Privilege Score',
                          type=int,
                          default=None)

    assess_parser = subparsers.add_parser('assess')
    assess_parser.add_argument('--assess',
                          required=False,
                          type=str2bool,
                          nargs='?',
                          const=True,
                          default='t',
                          help=argparse.SUPPRESS)
    assess_parser.add_argument('--curatorfile',
                          help='Path to curation file',
                          required=False,
                          default='curator.json')
    assess_parser.add_argument('--csv',
                          required=False,
                          type=str2bool,
                          nargs='?',
                          const=True,
                          default='f')


    args = parser.parse_args()
    mapper = Elem(args)
    mapper.run()

if __name__ == "__main__":
    main()
